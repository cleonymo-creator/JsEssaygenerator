<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essay Config Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #1a1a2e;
            --paper: #faf9f7;
            --paper-warm: #f5f3ef;
            --accent: #c9463d;
            --accent-soft: #e8d5d3;
            --sage: #5a7a6b;
            --sage-soft: #dce5e0;
            --gold: #b8860b;
            --border: #e0ddd8;
            --shadow: rgba(26, 26, 46, 0.08);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', -apple-system, sans-serif;
            background: var(--paper);
            color: var(--ink);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--ink);
            color: var(--paper);
            padding: 2rem 0;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(201, 70, 61, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(90, 122, 107, 0.15) 0%, transparent 50%);
            pointer-events: none;
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            opacity: 0.8;
            font-size: 1.1rem;
        }

        /* Main container */
        main {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Steps indicator */
        .steps {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 3rem;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 2px;
            background: var(--border);
            z-index: 0;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            max-width: 150px;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--paper);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .step.completed .step-number {
            background: var(--sage);
            border-color: var(--sage);
            color: white;
        }

        .step-label {
            font-size: 0.85rem;
            color: var(--ink);
            opacity: 0.6;
            text-align: center;
            transition: opacity 0.3s ease;
        }

        .step.active .step-label,
        .step.completed .step-label {
            opacity: 1;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--ink);
        }

        label .required {
            color: var(--accent);
        }

        .label-hint {
            font-weight: 400;
            font-size: 0.9rem;
            color: var(--ink);
            opacity: 0.6;
            display: block;
            margin-top: 0.25rem;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1rem;
            background: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px var(--sage-soft);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            line-height: 1.7;
        }

        /* Grid layout for form fields */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--sage-soft);
            color: var(--sage);
            border-radius: 6px;
            font-size: 1rem;
        }

        /* File upload */
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--paper-warm);
        }

        .file-upload:hover {
            border-color: var(--sage);
            background: var(--sage-soft);
        }

        .file-upload.dragover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .file-upload-text {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .file-upload-hint {
            font-size: 0.9rem;
            opacity: 0.6;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--sage-soft);
            border-radius: var(--radius);
            margin-top: 1rem;
        }

        .uploaded-file-icon {
            color: var(--sage);
        }

        .uploaded-file-name {
            flex: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .uploaded-file-remove {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
            line-height: 1;
        }

        /* Buttons */
        .button-row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        button {
            padding: 0.875rem 1.75rem;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        .btn-primary:hover:not(:disabled) {
            background: #a83a32;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: white;
            color: var(--ink);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: var(--ink);
        }

        .btn-success {
            background: var(--sage);
            color: white;
            border: none;
        }

        .btn-success:hover:not(:disabled) {
            background: #4a6a5b;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress / Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-card {
            background: white;
            padding: 3rem;
            border-radius: var(--radius);
            text-align: center;
            max-width: 400px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(201, 70, 61, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(201, 70, 61, 0); }
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .loading-subtext {
            font-size: 0.9rem;
            opacity: 0.6;
        }

        /* Output section */
        .output-preview {
            background: var(--ink);
            color: #e0e0e0;
            padding: 1.5rem;
            border-radius: var(--radius);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            max-height: 500px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .output-preview::-webkit-scrollbar {
            width: 8px;
        }

        .output-preview::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .output-preview::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .success-banner {
            background: var(--sage-soft);
            border: 1px solid var(--sage);
            color: var(--sage);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .success-banner svg {
            flex-shrink: 0;
        }

        /* Tabs for mark scheme input */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--ink);
            opacity: 0.6;
            cursor: pointer;
            position: relative;
            transition: opacity 0.2s ease;
        }

        .tab:hover {
            opacity: 0.8;
        }

        .tab.active {
            opacity: 1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tooltips */
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--border);
            color: var(--ink);
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: help;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            font-size: 0.9rem;
            opacity: 0.6;
            border-top: 1px solid var(--border);
            margin-top: 3rem;
        }

        /* Responsive */
        @media (max-width: 640px) {
            h1 {
                font-size: 1.75rem;
            }

            .card {
                padding: 1.5rem;
            }

            .steps::before {
                width: 80%;
            }

            .step-label {
                font-size: 0.75rem;
            }

            .button-row {
                flex-direction: column;
            }

            .button-row button {
                width: 100%;
                justify-content: center;
            }
        }

        /* API Key setup notice */
        .api-notice {
            background: linear-gradient(135deg, var(--accent-soft) 0%, var(--paper-warm) 100%);
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .api-notice-icon {
            color: var(--accent);
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .api-notice-text {
            font-size: 0.95rem;
        }

        .api-notice-text strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        .api-notice code {
            background: rgba(0,0,0,0.1);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-size: 0.9em;
        }

        /* Grade boundaries */
        .grade-boundaries-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .grade-boundary-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            padding: 0.75rem;
            background: var(--paper-warm);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .grade-boundary-row .form-group {
            margin-bottom: 0;
        }

        .grade-boundary-row label {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .grade-boundary-row input {
            padding: 0.625rem 0.75rem;
        }

        .btn-remove-grade {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-remove-grade:hover {
            opacity: 1;
        }

        .btn-add-grade {
            background: var(--sage-soft);
            color: var(--sage);
            border: 1px dashed var(--sage);
            padding: 0.625rem 1rem;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-add-grade:hover {
            background: var(--sage);
            color: white;
            border-style: solid;
        }

        /* Quick Start / Past Paper Search */
        .quick-start-card {
            background: linear-gradient(135deg, var(--ink) 0%, #2a2a4e 100%);
            color: var(--paper);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .quick-start-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(201, 70, 61, 0.2) 0%, transparent 70%);
            pointer-events: none;
        }

        .quick-start-card .card-title {
            color: var(--paper);
            border-bottom-color: rgba(255,255,255,0.2);
        }

        .quick-start-card .form-group label {
            color: var(--paper);
        }

        .quick-start-card .label-hint {
            color: rgba(255,255,255,0.7);
        }

        .quick-start-card input,
        .quick-start-card select {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: var(--paper);
        }

        .quick-start-card input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .quick-start-card input:focus,
        .quick-start-card select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(201, 70, 61, 0.3);
        }

        .quick-start-card select option {
            background: var(--ink);
            color: var(--paper);
        }

        .btn-search {
            background: var(--accent);
            color: white;
            border: none;
        }

        .btn-search:hover:not(:disabled) {
            background: #a83a32;
        }

        .or-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.2);
        }

        /* Search Results */
        .search-results {
            margin-top: 1.5rem;
        }

        .search-results-title {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--paper);
        }

        .question-result {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .question-result:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .question-result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .question-result-year {
            font-weight: 600;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .question-result-marks {
            background: var(--sage);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .question-result-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: rgba(255,255,255,0.9);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .question-result-paper {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            margin-top: 0.5rem;
        }

        .search-loading {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            color: rgba(255,255,255,0.8);
        }

        .search-loading .loading-spinner {
            width: 24px;
            height: 24px;
            border-width: 3px;
            margin: 0;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: rgba(255,255,255,0.6);
        }

        .search-error {
            background: rgba(201, 70, 61, 0.2);
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 1rem;
            color: var(--paper);
        }

        /* Selected question highlight */
        .question-result.selected {
            background: rgba(90, 122, 107, 0.2);
            border-color: var(--sage);
        }

        .question-result.selected::after {
            content: '‚úì Selected';
            display: block;
            margin-top: 0.5rem;
            color: var(--sage);
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Collapse toggle */
        .collapse-toggle {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .collapse-toggle:hover {
            color: var(--paper);
        }

        .collapse-toggle svg {
            transition: transform 0.2s;
        }

        .collapse-toggle.collapsed svg {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>√∞≈∏‚Äú¬ù Essay Config Generator</h1>
            <p class="subtitle">Transform exam questions into guided writing configurations</p>
        </div>
    </header>

    <main>
        <!-- Steps indicator -->
        <div class="steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <span class="step-label">Exam Details</span>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <span class="step-label">Question</span>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <span class="step-label">Mark Scheme</span>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <span class="step-label">Generate</span>
            </div>
        </div>

        <!-- Quick Start: Past Paper Search -->
        <div class="quick-start-card" id="quickStartCard">
            <h2 class="card-title">
                <span class="card-icon">üîç</span>
                Quick Start: Search Past Papers
            </h2>
            <p style="margin-bottom: 1.25rem; opacity: 0.8;">
                Search for past exam questions and auto-fill the form. Enter the exam board, subject, and optionally the paper and question number.
            </p>

            <div class="form-row">
                <div class="form-group">
                    <label for="searchExamBoard">Exam Board <span class="required">*</span></label>
                    <select id="searchExamBoard">
                        <option value="">Select exam board...</option>
                        <option value="AQA">AQA</option>
                        <option value="Edexcel">Edexcel / Pearson</option>
                        <option value="OCR">OCR</option>
                        <option value="WJEC">WJEC / Eduqas</option>
                        <option value="Cambridge">Cambridge International</option>
                        <option value="IB">International Baccalaureate</option>
                        <option value="SQA">SQA (Scotland)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchSubject">Subject <span class="required">*</span></label>
                    <input type="text" id="searchSubject" placeholder="e.g., English Language, History, Biology">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="searchPaper">Paper / Component</label>
                    <span class="label-hint">Optional - e.g., Paper 2, Component 1</span>
                    <input type="text" id="searchPaper" placeholder="e.g., Paper 2 Section B">
                </div>
                <div class="form-group">
                    <label for="searchQuestion">Question Number</label>
                    <span class="label-hint">Optional - e.g., Question 4, Q5</span>
                    <input type="text" id="searchQuestion" placeholder="e.g., Question 4">
                </div>
            </div>

            <button class="btn-search" onclick="searchPastPapers()" id="searchBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                Search Past Papers
            </button>

            <div id="searchResults"></div>

            <div class="or-divider">
                <span>or enter details manually below</span>
            </div>

            <button class="collapse-toggle" onclick="toggleQuickStart()" id="collapseToggle">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 9l-7 7-7-7"></path>
                </svg>
                <span>Hide quick start</span>
            </button>
        </div>

        <!-- Section 1: Basic Details -->
        <div class="section active" data-section="1">
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">√∞≈∏‚Äú‚Äπ</span>
                    Exam Information
                </h2>

                <div class="form-group">
                    <label for="subject">Subject <span class="required">*</span></label>
                    <input type="text" id="subject" placeholder="e.g., GCSE English Literature, A-Level History, IB Economics">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="yearGroup">Year Group <span class="required">*</span></label>
                        <input type="text" id="yearGroup" placeholder="e.g., Year 11, Grade 10">
                    </div>
                    <div class="form-group">
                        <label for="examBoard">Exam Board</label>
                        <input type="text" id="examBoard" placeholder="e.g., AQA, Edexcel, OCR">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="totalMarks">Total Marks <span class="required">*</span></label>
                        <input type="number" id="totalMarks" placeholder="e.g., 40" min="1">
                    </div>
                    <div class="form-group">
                        <label for="timeAllowed">Time Allowed (minutes)</label>
                        <input type="number" id="timeAllowed" placeholder="e.g., 45" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label for="paperName">Paper / Component Name</label>
                    <span class="label-hint">Optional - helps identify the specific exam paper</span>
                    <input type="text" id="paperName" placeholder="e.g., Paper 2 Section B, Component 1">
                </div>
            </div>

            <div class="button-row">
                <div></div>
                <button class="btn-primary" onclick="nextSection()">
                    Continue
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
        </div>

        <!-- Section 2: Exam Question -->
        <div class="section" data-section="2">
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">√¢¬ù‚Äú</span>
                    Exam Question
                </h2>

                <div class="form-group">
                    <label for="examQuestion">The Question <span class="required">*</span></label>
                    <span class="label-hint">Enter the exact exam question as students would see it</span>
                    <textarea id="examQuestion" placeholder="e.g., 'A magazine has asked for contributions for their special edition on technology in schools. Write an article arguing your point of view on this statement: Mobile phones should be banned in all schools.'"></textarea>
                </div>

                <div class="form-group">
                    <label>Source Material / Texts</label>
                    <span class="label-hint">If the question includes passages, extracts, poems, or data that students must reference</span>
                    <textarea id="sourceMaterial" placeholder="Paste any source texts, passages, poems, data tables, or stimulus material here. Include the full text students would have access to."></textarea>
                </div>

                <div class="form-group">
                    <label>Upload Source Documents</label>
                    <span class="label-hint">Optionally upload PDF or image files containing source material</span>
                    <div class="file-upload" id="sourceUpload">
                        <div class="file-upload-icon">√∞≈∏‚Äú‚Äû</div>
                        <div class="file-upload-text">Drop files here or click to browse</div>
                        <div class="file-upload-hint">PDF, PNG, JPG supported (max 10MB)</div>
                        <input type="file" id="sourceFiles" multiple accept=".pdf,.png,.jpg,.jpeg">
                    </div>
                    <div id="sourceFilesList"></div>
                </div>
            </div>

            <div class="button-row">
                <button class="btn-secondary" onclick="prevSection()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    Back
                </button>
                <button class="btn-primary" onclick="nextSection()">
                    Continue
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
        </div>

        <!-- Section 3: Mark Scheme -->
        <div class="section" data-section="3">
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">√¢≈ì‚Äù</span>
                    Mark Scheme
                </h2>

                <div class="tabs">
                    <button class="tab active" data-tab="paste">Paste Text</button>
                    <button class="tab" data-tab="upload">Upload PDF</button>
                </div>

                <div class="tab-content active" data-tab-content="paste">
                    <div class="form-group">
                        <label for="markScheme">Mark Scheme Details <span class="required">*</span></label>
                        <span class="label-hint">Include level descriptors, mark allocations, and assessment objectives</span>
                        <textarea id="markScheme" placeholder="Example:

Content and Organisation (24 marks)
Level 4 (19-24): Compelling, convincing communication; extensive, ambitious vocabulary; sustained crafting
Level 3 (13-18): Clear, controlled; increasingly sophisticated vocabulary; conscious crafting
Level 2 (7-12): Some attempts to match purpose; some vocabulary; some structural features
Level 1 (1-6): Simple awareness; simple vocabulary; limited structural features

Technical Accuracy (16 marks)
Level 4 (13-16): Wide range of punctuation; high level of accuracy
Level 3 (9-12): Range of punctuation; accuracy of grammar
..."></textarea>
                    </div>
                </div>

                <div class="tab-content" data-tab-content="upload">
                    <div class="form-group">
                        <div class="file-upload" id="markSchemeUpload">
                            <div class="file-upload-icon">√∞≈∏‚Äú‚Äπ</div>
                            <div class="file-upload-text">Drop mark scheme PDF here or click to browse</div>
                            <div class="file-upload-hint">PDF files supported (max 10MB)</div>
                            <input type="file" id="markSchemeFile" accept=".pdf">
                        </div>
                        <div id="markSchemeFileDisplay"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="additionalNotes">Additional Notes</label>
                    <span class="label-hint">Any specific requirements, common mistakes to address, or examiner feedback</span>
                    <textarea id="additionalNotes" style="min-height: 100px;" placeholder="e.g., Students often forget to include a counter-argument. Must use formal register throughout. Technical terminology expected includes..."></textarea>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">√∞≈∏‚Äú≈†</span>
                    Grade Boundaries (Optional)
                </h2>
                <p style="margin-bottom: 1rem; opacity: 0.8; font-size: 0.95rem;">
                    Provide grade boundaries to generate descriptors based on the mark scheme. For best results, include at least <strong>3 boundaries</strong> (e.g., low, mid, and high grades). Missing boundaries will be interpolated automatically.
                </p>

                <div class="boundary-hints" style="background: var(--sage-soft); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem; font-size: 0.9rem;">
                    <strong>√∞≈∏‚Äô¬° Suggested minimum:</strong> Enter boundaries for your lowest passing grade, a middle grade, and the top grade. For example:
                    <ul style="margin: 0.5rem 0 0 1.5rem; opacity: 0.9;">
                        <li>GCSE: Grade 4, Grade 6, Grade 9</li>
                        <li>A-Level: Grade E, Grade C, Grade A*</li>
                        <li>IB: Level 3, Level 5, Level 7</li>
                    </ul>
                </div>

                <div class="grade-boundaries-container" id="gradeBoundariesContainer">
                    <div class="grade-boundary-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Grade</label>
                            <input type="text" class="grade-name" placeholder="e.g., 9, A*, Distinction">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Min Marks</label>
                            <input type="number" class="grade-min" placeholder="e.g., 36" min="0">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Max Marks</label>
                            <input type="number" class="grade-max" placeholder="e.g., 40" min="0">
                        </div>
                        <button type="button" class="btn-remove-grade" onclick="removeGradeBoundary(this)" title="Remove">&times;</button>
                    </div>
                </div>
                
                <button type="button" class="btn-add-grade" onclick="addGradeBoundary()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                    Add Grade Boundary
                </button>

                <div class="form-group" style="margin-top: 1rem;">
                    <label>
                        <input type="checkbox" id="includeGradeDescriptors" checked>
                        Generate detailed descriptors for each grade
                    </label>
                    <span class="label-hint">Claude will create specific criteria descriptions for what constitutes each grade level, and interpolate any missing grades</span>
                </div>
            </div>

            <div class="button-row">
                <button class="btn-secondary" onclick="prevSection()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    Back
                </button>
                <button class="btn-primary" onclick="nextSection()">
                    Continue
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
        </div>

        <!-- Section 4: Review & Generate -->
        <div class="section" data-section="4">
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">√¢≈°‚Ñ¢√Ø¬∏¬è</span>
                    Configuration Options
                </h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="minWords">Min Words per Paragraph</label>
                        <input type="number" id="minWords" value="80" min="20" max="500">
                    </div>
                    <div class="form-group">
                        <label for="targetWords">Target Words per Paragraph</label>
                        <input type="number" id="targetWords" value="150" min="50" max="800">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="maxAttempts">Max Attempts per Paragraph</label>
                        <input type="number" id="maxAttempts" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label for="teacherPassword">Teacher Password</label>
                        <input type="text" id="teacherPassword" value="teacher123">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">√∞≈∏‚Äú¬ù</span>
                    Review Your Input
                </h2>
                <div id="reviewSummary" style="line-height: 1.8;"></div>
            </div>

            <div class="button-row">
                <button class="btn-secondary" onclick="prevSection()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    Back
                </button>
                <button class="btn-success" onclick="generateConfig()" id="generateBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>
                    Generate Configuration
                </button>
            </div>
        </div>

        <!-- Output Section (hidden until generated) -->
        <div class="section" data-section="5">
            <div class="success-banner">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                <span>Configuration generated successfully! Download the file and save it as <code>config/essay.js</code> in your project.</span>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">√∞≈∏‚Äú‚Äû</span>
                    Generated Configuration
                </h2>
                <pre class="output-preview" id="outputPreview"></pre>
            </div>

            <div class="button-row">
                <button class="btn-secondary" onclick="startOver()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    Start Over
                </button>
                <button class="btn-primary" onclick="downloadConfig()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Download essay.js
                </button>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-text">Generating Configuration...</div>
            <div class="loading-subtext">Claude is analysing your exam and creating a structured essay plan</div>
        </div>
    </div>

    <footer>
        Essay Config Generator √¢‚Ç¨¬¢ Powered by Claude AI
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // State management
        let currentSection = 1;
        let uploadedSourceFiles = [];
        let uploadedMarkSchemeFile = null;
        let generatedConfig = '';
        let selectedPastPaperQuestion = null;
        let quickStartCollapsed = false;

        // Extract text from PDF using PDF.js
        async function extractPdfText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            
            return fullText.trim();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupFileUploads();
            setupTabs();
            updateReviewSummary();
        });

        // Tab switching
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabGroup = tab.parentElement;
                    const contentGroup = tabGroup.nextElementSibling.parentElement;
                    const targetTab = tab.dataset.tab;

                    tabGroup.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.toggle('active', content.dataset.tabContent === targetTab);
                    });
                });
            });
        }

        // Quick Start / Past Paper Search Functions
        function toggleQuickStart() {
            const card = document.getElementById('quickStartCard');
            const toggle = document.getElementById('collapseToggle');
            quickStartCollapsed = !quickStartCollapsed;
            
            if (quickStartCollapsed) {
                card.style.maxHeight = '60px';
                card.style.overflow = 'hidden';
                toggle.classList.add('collapsed');
                toggle.querySelector('span').textContent = 'Show quick start';
            } else {
                card.style.maxHeight = 'none';
                card.style.overflow = 'visible';
                toggle.classList.remove('collapsed');
                toggle.querySelector('span').textContent = 'Hide quick start';
            }
        }

        async function searchPastPapers() {
            const examBoard = document.getElementById('searchExamBoard').value;
            const subject = document.getElementById('searchSubject').value.trim();
            const paper = document.getElementById('searchPaper').value.trim();
            const questionNumber = document.getElementById('searchQuestion').value.trim();

            if (!examBoard) {
                alert('Please select an exam board');
                return;
            }
            if (!subject) {
                alert('Please enter a subject');
                return;
            }

            const btn = document.getElementById('searchBtn');
            const resultsContainer = document.getElementById('searchResults');
            
            btn.disabled = true;
            resultsContainer.innerHTML = `
                <div class="search-loading">
                    <div class="loading-spinner"></div>
                    <span>Starting search...</span>
                </div>
            `;

            try {
                // Start the search job
                const startResponse = await fetch('/.netlify/functions/start-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ examBoard, subject, paper, questionNumber })
                });

                if (!startResponse.ok) {
                    throw new Error(`Failed to start search: ${startResponse.status}`);
                }

                const { jobId } = await startResponse.json();
                console.log('Search job started:', jobId);

                resultsContainer.innerHTML = `
                    <div class="search-loading">
                        <div class="loading-spinner"></div>
                        <span>Searching past papers... This may take up to 30 seconds.</span>
                    </div>
                `;

                // Trigger the background processor
                fetch('/.netlify/functions/process-search-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jobId })
                }).catch(err => console.log('Background trigger sent'));

                // Poll for result
                const result = await pollForSearchResult(jobId);
                
                if (result.status === 'error') {
                    throw new Error(typeof result.error === 'string' ? result.error : JSON.stringify(result.error));
                }

                if (result.result) {
                    displaySearchResults(result.result);
                } else {
                    throw new Error('No results returned');
                }

            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `
                    <div class="search-error">
                        <strong>Search failed:</strong> ${error.message}<br>
                        <span style="opacity: 0.8; font-size: 0.9rem;">You can still enter the exam details manually below.</span>
                    </div>
                `;
            } finally {
                btn.disabled = false;
            }
        }

        async function pollForSearchResult(jobId, maxAttempts = 40, interval = 2000) {
            for (let i = 0; i < maxAttempts; i++) {
                await sleep(interval);
                console.log(`Polling search ${i + 1}/${maxAttempts}...`);
                
                try {
                    const response = await fetch(`/.netlify/functions/check-job?jobId=${encodeURIComponent(jobId)}`);
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Search status:', result.status);
                        
                        if (result.status === 'completed' || result.status === 'error') {
                            return result;
                        }
                    }
                    
                    // Update loading message
                    const loadingSpan = document.querySelector('.search-loading span');
                    if (loadingSpan) {
                        const elapsed = Math.round((i + 1) * interval / 1000);
                        loadingSpan.textContent = `Searching past papers... (${elapsed}s)`;
                    }
                } catch (e) {
                    console.error('Poll error:', e);
                }
            }
            throw new Error('Search timed out. Please try again.');
        }

        function displaySearchResults(data) {
            const container = document.getElementById('searchResults');
            
            if (data.error) {
                container.innerHTML = `
                    <div class="search-error">
                        <strong>Error:</strong> ${typeof data.error === 'string' ? data.error : JSON.stringify(data.error)}
                    </div>
                `;
                return;
            }

            if (!data.questions || data.questions.length === 0) {
                let message = '<div class="no-results">';
                message += '<p><strong>No specific past papers found.</strong></p>';
                if (data.rawResponse) {
                    message += `<p style="margin-top: 1rem; text-align: left; font-size: 0.9rem;">${data.rawResponse.substring(0, 500)}${data.rawResponse.length > 500 ? '...' : ''}</p>`;
                }
                message += '<p style="margin-top: 1rem;">Try adjusting your search terms or enter details manually.</p>';
                message += '</div>';
                container.innerHTML = message;
                return;
            }

            let html = `
                <div class="search-results">
                    <h3 class="search-results-title">Found ${data.questions.length} question${data.questions.length > 1 ? 's' : ''} - Click to use:</h3>
            `;

            data.questions.forEach((q, index) => {
                html += `
                    <div class="question-result" onclick="selectQuestion(${index})" data-index="${index}">
                        <div class="question-result-header">
                            <span class="question-result-year">${q.year || 'Unknown year'}</span>
                            ${q.totalMarks ? `<span class="question-result-marks">${q.totalMarks} marks</span>` : ''}
                        </div>
                        <div class="question-result-text">${escapeHtml(q.questionText || 'No question text available')}</div>
                        ${q.paperName ? `<div class="question-result-paper">${escapeHtml(q.paperName)}</div>` : ''}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

            // Store the questions data for selection
            window.searchResultsData = data.questions;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function selectQuestion(index) {
            const questions = window.searchResultsData;
            if (!questions || !questions[index]) return;

            const q = questions[index];
            selectedPastPaperQuestion = q;

            // Update visual selection
            document.querySelectorAll('.question-result').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });

            // Auto-fill the form fields
            populateFormFromQuestion(q);

            // Show a brief confirmation
            const resultsTitle = document.querySelector('.search-results-title');
            if (resultsTitle) {
                resultsTitle.innerHTML = `Found ${questions.length} question${questions.length > 1 ? 's' : ''} - <span style="color: var(--sage);">‚úì Question selected!</span>`;
            }

            // Scroll to the form section after a brief delay
            setTimeout(() => {
                document.querySelector('[data-section="1"]').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        function populateFormFromQuestion(q) {
            // Get exam info from search
            const examBoard = document.getElementById('searchExamBoard').value;
            const searchSubject = document.getElementById('searchSubject').value;
            
            // Populate Section 1: Exam Details
            document.getElementById('subject').value = searchSubject || '';
            document.getElementById('examBoard').value = examBoard || '';
            
            if (q.totalMarks) {
                document.getElementById('totalMarks').value = q.totalMarks;
            }
            
            if (q.paperName) {
                document.getElementById('paperName').value = q.paperName;
            }
            
            // Try to infer year group from subject
            const subjectLower = searchSubject.toLowerCase();
            if (subjectLower.includes('gcse')) {
                document.getElementById('yearGroup').value = 'Year 11';
            } else if (subjectLower.includes('a-level') || subjectLower.includes('a level')) {
                document.getElementById('yearGroup').value = 'Year 13';
            } else if (subjectLower.includes('ib')) {
                document.getElementById('yearGroup').value = 'Year 13';
            }

            // Populate Section 2: Exam Question
            if (q.questionText) {
                document.getElementById('examQuestion').value = q.questionText;
            }
            
            if (q.sourceMaterial) {
                document.getElementById('sourceMaterial').value = q.sourceMaterial;
            }

            // Populate Section 3: Mark Scheme
            if (q.markScheme) {
                document.getElementById('markScheme').value = q.markScheme;
            }

            // Add source URL to additional notes if available
            if (q.sourceUrl) {
                const currentNotes = document.getElementById('additionalNotes').value;
                const sourceNote = `Source: ${q.sourceUrl}`;
                if (!currentNotes.includes(sourceNote)) {
                    document.getElementById('additionalNotes').value = currentNotes 
                        ? currentNotes + '\n\n' + sourceNote 
                        : sourceNote;
                }
            }

            // Update the review summary
            updateReviewSummary();
        }

        // File upload handling
        function setupFileUploads() {
            // Source files upload
            const sourceUpload = document.getElementById('sourceUpload');
            const sourceInput = document.getElementById('sourceFiles');

            sourceUpload.addEventListener('click', () => sourceInput.click());
            sourceUpload.addEventListener('dragover', handleDragOver);
            sourceUpload.addEventListener('dragleave', handleDragLeave);
            sourceUpload.addEventListener('drop', (e) => handleDrop(e, 'source'));
            sourceInput.addEventListener('change', (e) => handleFileSelect(e, 'source'));

            // Mark scheme upload
            const markSchemeUpload = document.getElementById('markSchemeUpload');
            const markSchemeInput = document.getElementById('markSchemeFile');

            markSchemeUpload.addEventListener('click', () => markSchemeInput.click());
            markSchemeUpload.addEventListener('dragover', handleDragOver);
            markSchemeUpload.addEventListener('dragleave', handleDragLeave);
            markSchemeUpload.addEventListener('drop', (e) => handleDrop(e, 'markScheme'));
            markSchemeInput.addEventListener('change', (e) => handleFileSelect(e, 'markScheme'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files, type);
        }

        function handleFileSelect(e, type) {
            const files = e.target.files;
            processFiles(files, type);
        }

        async function processFiles(files, type) {
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 10MB.`);
                    continue;
                }

                // Show processing indicator
                showProcessingIndicator(type, `Processing ${file.name}...`);

                try {
                    let fileData;
                    
                    if (file.type === 'application/pdf') {
                        // Extract text from PDF instead of sending raw PDF
                        console.log(`Extracting text from PDF: ${file.name}`);
                        const extractedText = await extractPdfText(file);
                        console.log(`Extracted ${extractedText.length} characters from ${file.name}`);
                        
                        fileData = {
                            name: file.name,
                            type: 'text/plain',
                            extractedText: extractedText,
                            originalType: 'application/pdf'
                        };
                    } else if (file.type.startsWith('image/')) {
                        // For images, keep as base64
                        fileData = {
                            name: file.name,
                            type: file.type,
                            content: await readFileAsBase64(file)
                        };
                    } else {
                        alert(`Unsupported file type: ${file.name}`);
                        continue;
                    }

                    if (type === 'source') {
                        uploadedSourceFiles.push(fileData);
                        updateSourceFilesList();
                    } else {
                        uploadedMarkSchemeFile = fileData;
                        updateMarkSchemeDisplay();
                    }
                } catch (error) {
                    console.error('File processing error:', error);
                    alert(`Error processing ${file.name}: ${error.message}`);
                } finally {
                    hideProcessingIndicator(type);
                }
            }
        }

        function showProcessingIndicator(type, text) {
            const containerId = type === 'source' ? 'sourceFilesList' : 'markSchemeFileDisplay';
            const container = document.getElementById(containerId);
            let indicator = document.getElementById(`processing-${type}`);
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = `processing-${type}`;
                indicator.className = 'uploaded-file';
                indicator.style.opacity = '0.7';
            }
            indicator.innerHTML = `<span class="uploaded-file-icon">√¢¬è¬≥</span><span class="uploaded-file-name">${text}</span>`;
            container.appendChild(indicator);
        }

        function hideProcessingIndicator(type) {
            const indicator = document.getElementById(`processing-${type}`);
            if (indicator) indicator.remove();
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateSourceFilesList() {
            const container = document.getElementById('sourceFilesList');
            container.innerHTML = uploadedSourceFiles.map((file, index) => `
                <div class="uploaded-file">
                    <span class="uploaded-file-icon">${file.extractedText ? '√∞≈∏‚Äú¬ù' : '√∞≈∏‚Äú‚Äû'}</span>
                    <span class="uploaded-file-name">${file.name}${file.extractedText ? ' (text extracted)' : ''}</span>
                    <button class="uploaded-file-remove" onclick="removeSourceFile(${index})">&times;</button>
                </div>
            `).join('');
        }

        function removeSourceFile(index) {
            uploadedSourceFiles.splice(index, 1);
            updateSourceFilesList();
        }

        function updateMarkSchemeDisplay() {
            const container = document.getElementById('markSchemeFileDisplay');
            if (uploadedMarkSchemeFile) {
                container.innerHTML = `
                    <div class="uploaded-file">
                        <span class="uploaded-file-icon">${uploadedMarkSchemeFile.extractedText ? '√∞≈∏‚Äú¬ù' : '√∞≈∏‚Äú‚Äπ'}</span>
                        <span class="uploaded-file-name">${uploadedMarkSchemeFile.name}${uploadedMarkSchemeFile.extractedText ? ' (text extracted)' : ''}</span>
                        <button class="uploaded-file-remove" onclick="removeMarkSchemeFile()">&times;</button>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        function removeMarkSchemeFile() {
            uploadedMarkSchemeFile = null;
            updateMarkSchemeDisplay();
            document.getElementById('markSchemeFile').value = '';
        }

        // Navigation
        function nextSection() {
            if (validateSection(currentSection)) {
                if (currentSection < 4) {
                    goToSection(currentSection + 1);
                }
            }
        }

        function prevSection() {
            if (currentSection > 1) {
                goToSection(currentSection - 1);
            }
        }

        function goToSection(section) {
            currentSection = section;

            // Update sections visibility
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Update steps
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');
                if (stepNum === section) {
                    step.classList.add('active');
                } else if (stepNum < section) {
                    step.classList.add('completed');
                }
            });

            // Update review summary if on section 4
            if (section === 4) {
                updateReviewSummary();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateSection(section) {
            const errors = [];

            if (section === 1) {
                if (!document.getElementById('subject').value.trim()) errors.push('Subject is required');
                if (!document.getElementById('yearGroup').value.trim()) errors.push('Year Group is required');
                if (!document.getElementById('totalMarks').value) errors.push('Total Marks is required');
            }

            if (section === 2) {
                if (!document.getElementById('examQuestion').value.trim()) errors.push('Exam question is required');
            }

            if (section === 3) {
                const markSchemeText = document.getElementById('markScheme').value.trim();
                if (!markSchemeText && !uploadedMarkSchemeFile) {
                    errors.push('Please either paste the mark scheme or upload a PDF');
                }
            }

            if (errors.length > 0) {
                alert(errors.join('\n'));
                return false;
            }
            return true;
        }

        function updateReviewSummary() {
            const boundaries = getGradeBoundaries();
            const boundariesText = boundaries.length > 0 
                ? boundaries.map(b => `${b.grade}: ${b.minMarks || '?'}-${b.maxMarks || '?'}`).join(', ')
                : 'Not specified';
            
            const summary = document.getElementById('reviewSummary');
            summary.innerHTML = `
                <p><strong>Subject:</strong> ${document.getElementById('subject').value || 'Not specified'}</p>
                <p><strong>Year Group:</strong> ${document.getElementById('yearGroup').value || 'Not specified'}</p>
                <p><strong>Exam Board:</strong> ${document.getElementById('examBoard').value || 'Not specified'}</p>
                <p><strong>Total Marks:</strong> ${document.getElementById('totalMarks').value || 'Not specified'}</p>
                <p><strong>Time Allowed:</strong> ${document.getElementById('timeAllowed').value ? document.getElementById('timeAllowed').value + ' minutes' : 'Not specified'}</p>
                <p><strong>Question:</strong> ${document.getElementById('examQuestion').value.substring(0, 100)}${document.getElementById('examQuestion').value.length > 100 ? '...' : ''}</p>
                <p><strong>Source Files:</strong> ${uploadedSourceFiles.length > 0 ? uploadedSourceFiles.map(f => f.name).join(', ') : 'None'}</p>
                <p><strong>Mark Scheme:</strong> ${uploadedMarkSchemeFile ? uploadedMarkSchemeFile.name : (document.getElementById('markScheme').value ? 'Provided (text)' : 'Not provided')}</p>
                <p><strong>Grade Boundaries:</strong> ${boundariesText}</p>
            `;
        }

        // Generation with job queue and polling
        async function generateConfig() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            document.getElementById('loadingOverlay').classList.add('active');
            updateLoadingText('Starting generation...');

            try {
                const payload = buildPayload();
                const payloadString = JSON.stringify(payload);
                const payloadSizeMB = (payloadString.length / (1024 * 1024)).toFixed(2);
                console.log('Payload size:', payloadSizeMB, 'MB');
                
                if (payloadString.length > 5 * 1024 * 1024) {
                    throw new Error(`Payload too large (${payloadSizeMB}MB). Please remove PDF files and paste text instead.`);
                }

                // Start the job (saves to Blobs)
                console.log('Starting job...');
                const startResponse = await fetch('/.netlify/functions/start-job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payloadString
                });

                if (!startResponse.ok) {
                    const errorText = await startResponse.text();
                    throw new Error(`Failed to start: ${startResponse.status} - ${errorText}`);
                }

                const { jobId } = await startResponse.json();
                console.log('Job started:', jobId);
                updateLoadingText('Processing with Claude Sonnet...');

                // Trigger the background processor (will return 202 immediately)
                console.log('Triggering background processor...');
                fetch('/.netlify/functions/process-job-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jobId })
                }).then(res => {
                    console.log('Background function response:', res.status);
                }).catch(err => console.log('Background trigger sent (expected):', err.message));

                // Poll for result
                const result = await pollForResult(jobId);
                
                if (result.status === 'error') {
                    throw new Error(typeof result.error === 'string' ? result.error : JSON.stringify(result.error));
                }

                if (result.config) {
                    generatedConfig = result.config;
                    document.getElementById('outputPreview').textContent = generatedConfig;
                    goToSection(5);
                } else {
                    throw new Error('No config in result');
                }

            } catch (error) {
                console.error('Generation error:', error);
                alert('Error generating configuration: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
                btn.disabled = false;
            }
        }

        function updateLoadingText(text) {
            const el = document.querySelector('.loading-text');
            if (el) el.textContent = text;
        }

        async function pollForResult(jobId, maxAttempts = 120, interval = 3000) {
            for (let i = 0; i < maxAttempts; i++) {
                await sleep(interval);
                console.log(`Polling ${i + 1}/${maxAttempts}...`);
                
                try {
                    const response = await fetch(`/.netlify/functions/check-job?jobId=${encodeURIComponent(jobId)}`);
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Status:', result.status);
                        
                        if (result.status === 'completed' || result.status === 'error') {
                            return result;
                        }
                    }
                    const elapsed = Math.round((i + 1) * interval / 1000);
                    updateLoadingText(`Processing with Claude Sonnet... (${elapsed}s)`);
                } catch (e) {
                    console.error('Poll error:', e);
                }
            }
            throw new Error('Generation timed out. Please try again.');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Add more grade boundaries
        function addGradeBoundary() {
            const container = document.getElementById('gradeBoundariesContainer');
            const row = document.createElement('div');
            row.className = 'grade-boundary-row';
            row.innerHTML = `
                <div class="form-group" style="flex: 1;">
                    <label>Grade</label>
                    <input type="text" class="grade-name" placeholder="e.g., 9, A*, Distinction">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Min Marks</label>
                    <input type="number" class="grade-min" placeholder="e.g., 36" min="0">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Max Marks</label>
                    <input type="number" class="grade-max" placeholder="e.g., 40" min="0">
                </div>
                <button type="button" class="btn-remove-grade" onclick="removeGradeBoundary(this)" title="Remove">&times;</button>
            `;
            container.appendChild(row);
        }

        function removeGradeBoundary(btn) {
            const container = document.getElementById('gradeBoundariesContainer');
            if (container.children.length > 1) {
                btn.closest('.grade-boundary-row').remove();
            }
        }

        function getGradeBoundaries() {
            const boundaries = [];
            document.querySelectorAll('.grade-boundary-row').forEach(row => {
                const grade = row.querySelector('.grade-name').value.trim();
                const min = row.querySelector('.grade-min').value;
                const max = row.querySelector('.grade-max').value;
                if (grade && (min || max)) {
                    boundaries.push({
                        grade,
                        minMarks: min ? parseInt(min) : null,
                        maxMarks: max ? parseInt(max) : null
                    });
                }
            });
            // Sort by minMarks descending (highest grade first)
            return boundaries.sort((a, b) => (b.minMarks || 0) - (a.minMarks || 0));
        }

        function buildPayload() {
            // Process source files - convert extracted PDF text to sourceMaterial
            let additionalSourceText = '';
            const imageFiles = [];
            
            for (const file of uploadedSourceFiles) {
                if (file.extractedText) {
                    // PDF was converted to text
                    additionalSourceText += `\n\n--- Content from ${file.name} ---\n${file.extractedText}`;
                } else if (file.content) {
                    // Image file - keep as is
                    imageFiles.push(file);
                }
            }

            // Combine manual source material with extracted PDF text
            const combinedSourceMaterial = document.getElementById('sourceMaterial').value + additionalSourceText;

            // Process mark scheme file
            let markSchemeText = document.getElementById('markScheme').value;
            if (uploadedMarkSchemeFile?.extractedText) {
                markSchemeText += `\n\n--- Content from ${uploadedMarkSchemeFile.name} ---\n${uploadedMarkSchemeFile.extractedText}`;
            }

            // Only include mark scheme file if it's an image (not extracted PDF)
            const markSchemeFileData = uploadedMarkSchemeFile?.content ? uploadedMarkSchemeFile : null;

            return {
                subject: document.getElementById('subject').value,
                yearGroup: document.getElementById('yearGroup').value,
                examBoard: document.getElementById('examBoard').value,
                totalMarks: parseInt(document.getElementById('totalMarks').value),
                timeAllowed: document.getElementById('timeAllowed').value ? parseInt(document.getElementById('timeAllowed').value) : null,
                paperName: document.getElementById('paperName').value,
                examQuestion: document.getElementById('examQuestion').value,
                sourceMaterial: combinedSourceMaterial,
                sourceFiles: imageFiles, // Only images now, PDFs converted to text
                markScheme: markSchemeText,
                markSchemeFile: markSchemeFileData, // Only if it's an image
                additionalNotes: document.getElementById('additionalNotes').value,
                minWords: parseInt(document.getElementById('minWords').value),
                targetWords: parseInt(document.getElementById('targetWords').value),
                maxAttempts: parseInt(document.getElementById('maxAttempts').value),
                teacherPassword: document.getElementById('teacherPassword').value,
                gradeBoundaries: getGradeBoundaries(),
                includeGradeDescriptors: document.getElementById('includeGradeDescriptors').checked
            };
        }

        function downloadConfig() {
            const blob = new Blob([generatedConfig], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'essay.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function startOver() {
            // Reset form
            document.querySelectorAll('input, textarea').forEach(el => {
                if (el.type === 'number') {
                    el.value = el.defaultValue;
                } else if (el.type === 'text' || el.tagName === 'TEXTAREA') {
                    el.value = '';
                } else if (el.type === 'checkbox') {
                    el.checked = el.defaultChecked;
                }
            });

            // Reset file uploads
            uploadedSourceFiles = [];
            uploadedMarkSchemeFile = null;
            updateSourceFilesList();
            updateMarkSchemeDisplay();

            // Reset grade boundaries to single empty row
            const container = document.getElementById('gradeBoundariesContainer');
            container.innerHTML = `
                <div class="grade-boundary-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Grade</label>
                        <input type="text" class="grade-name" placeholder="e.g., 9, A*, Distinction">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Min Marks</label>
                        <input type="number" class="grade-min" placeholder="e.g., 36" min="0">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Max Marks</label>
                        <input type="number" class="grade-max" placeholder="e.g., 40" min="0">
                    </div>
                    <button type="button" class="btn-remove-grade" onclick="removeGradeBoundary(this)" title="Remove">&times;</button>
                </div>
            `;

            // Reset tabs
            document.querySelectorAll('.tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === 0);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === 0);
            });

            // Go to first section
            goToSection(1);
        }
    </script>
</body>
</html>
